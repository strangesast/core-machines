<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title></title>
  <style>
    body {
    }
  </style>
</head>
<body>
  <pre></pre>
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <script src="https://d3js.org/d3-array.v2.min.js"></script>
  <script>
    const pre = document.querySelector('pre');
    const url = new URL('/ws', 'ws:' + window.location.origin.slice(window.location.protocol.length))
    const socket = new WebSocket(url);

    socket.onopen = (e) => console.log('socket opened');

    const cols = [
      {'title': 'Condition', key: 'CONDITION', cols: ['itemid', 'tag', 'attrs.type', 'timestamp'], id: 'itemid'},
      {'title': 'Samples',   key: 'SAMPLE',    cols: ['itemid', 'value', 'timestamp'],             id: 'itemid'},
      {'title': 'Events',    key: 'EVENT',     cols: ['itemid', 'tag', 'value', 'timestamp'],      id: 'sequence'},
    ]

    const formatDate = d3.timeFormat('%x %H:%M:%S.%L');
    socket.onmessage = (e) => {
      let data;
      try {
        data = JSON.parse(e.data);
      } catch (err) {
        return;
      };

      data = data['samples'];

      if (!data) {
        return;
      }

      for (const sample of data) {
        sample['timestamp'] = new Date(sample['timestamp']);
      }

      data = d3.group(data, d => d.type);

      d3.select(document.body).selectAll('section').data(cols, d => d.key)
        .join(
          enter => enter.append('section')
            .call(s => s.append('h1').text(d => d.title))
            .call(s => s.append('table')
              .call(s => s.append('thead').append('tr').selectAll('th').data(d => d.cols).join('th').text(d => d))
              .call(s => s.append('tbody'))
            )
        )
        .each(function (d) {
          d3.select(this).select('tbody')
            .selectAll('tr')
            .data(d =>
              (data.get(d.key) || [])
                .sort((a, b) => d3.descending(a.timestamp, b.timestamp))
                .map(e => [
                  e[d.id],
                  d.cols.map(key => [key, key.split('.').reduce((acc, cv) => acc[cv], e)])
                ])
              , d => d[0]
            )
            .join(
              enter => enter.append('tr'),
              update => update,
              exit => exit,
            )
            // .sort((a, b) => d3.descending(a[0], b[0])
            .selectAll('td')
            .data(d => d[1])
            .join('td')
            .text(d => d[0] == 'timestamp' ? formatDate(d[1]) : d[1])
        });
    };
  </script>
</body>
</html>
